"use strict";function QRCodeDecode(){this.logger=null;this.debug_addText=true;this.debug_encodeWithErrorCorrection=true;this.debug_encodeBestMask=true;this.debug_addErrorCorrection=true;this.debug_setBlocks=true;this.debug_findModuleSize=true;this.debug_extractCodewords=true;this.debug_extractData=true;this.debug_correctErrors=true;this.debug_insane=false;this.image=null;this.image_top=0;this.image_bottom=0;this.image_left=0;this.image_right=0;this.n_modules=0;this.module_size=0;this.version=0;this.functional_grade=0;this.error_correction_level=0;this.mask=0;this.mask_pattern=[];this.n_block_ec_words=0;this.block_indices=[];this.block_data_lengths=[]}function ReedSolomon(e){this.logger=null;this.n_ec_bytes=e;this.n_degree_max=2*e;this.syndroms=[];this.gen_poly=null;this.initGaloisTables()}QRCodeDecode.prototype={MODE:{Numeric:1,AlphaNumeric:2,EightBit:4,Terminator:0},ERROR_CORRECTION_LEVEL:{L:1,M:0,Q:3,H:2},encodeToCanvas:function(e,t,n,r,i,s,o,u){if(!o){o=[.98,.98,1]}if(!u){u=[.3,.05,.05]}var a=s.getContext("2d");s.setBackground=function(){a.fillStyle="rgb("+Math.round(o[0]*255)+","+Math.round(o[1]*255)+","+Math.round(o[2]*255)+")";a.fillRect(0,0,s.width,s.height);a.fillStyle="rgb("+Math.round(u[0]*255)+","+Math.round(u[1]*255)+","+Math.round(u[2]*255)+")"};s.setDark=function(e,t,n){a.fillRect(e,t,n,n)};this.encodeInit(n,r,i,s);this.encodeAddText(e,t);this.encode()},encodeToPixarray:function(e,t,n,r){var i=this.nModulesFromVersion(n)+4+4;var s={};s.width=i;s.height=i;s.arr=[];var o;for(o=0;o<i;o++){s.arr[o]=[]}s.setBackground=function(){for(o=0;o<i;o++){var e;for(e=0;e<i;e++){this.arr[o][e]=false}}};s.setDark=function(e,t,n){if(e>i-1){return}this.arr[e][t]=true};s.isDark=function(e,t,n){if(e>this.n_modules-1){return false}return s.arr[e][t]};this.encodeInit(n,r,1,s);this.encodeAddText(e,t);this.encode();return s},encodeInit:function(e,t,n,r){this.version=e;this.error_correction_level=t;this.module_size=n;this.n_modules=this.nModulesFromVersion(e);this.image=r;this.image_top=4*n;this.image_left=4*n;this.image.width=(4+4+this.n_modules)*n;this.image.height=(4+4+this.n_modules)*n;this.image.setBackground();this.bit_idx=0;this.setBlocks();this.data=[];var i;for(i=0;i<this.n_data_codewords;i++){this.data[i]=0}this.pixels=[];for(i=0;i<this.n_modules;i++){this.pixels[i]=[]}},encodeAddText:function(e,t){this.addTextImplementation(e,t)},encode:function(){this.addTextImplementation(this.MODE.Terminator,null);this.appendPadding();this.addErrorCorrection();this.encodeBestMask();this.pixelsToImage()},decodePixarray:function(e){return this.decodeImage(e)},decodeImageData:function(e,t,n){this.setImageData(e,t,n);return this.decode()},decodeImageDataInsideBordersWithMaxVersion:function(e,t,n,r,i,s,o,u){this.setImageData(e,t,n);this.image_left=r;this.image_right=i;this.image_top=s;this.image_bottom=o;this.image_size=(this.image_right-this.image_left+1+(this.image_bottom-this.image_top+1))/2;this.max_version=u;return this.decodeInsideBordersWithMaxVersion()},setImageData:function(e,t,n){e.min_col=255;e.max_col=0;var r=0;var i,s;for(i=0;i<t;i++){for(s=0;s<n;s++){var o=i*4+s*t*4;var u=.3*e.data[o]+.59*e.data[o+1]+.11*e.data[o+2];r+=u;if(u<e.min_col){e.min_col=u}if(u>e.max_col){e.max_col=u}}}if(e.max_col-e.min_col<255/10){throw"Image does not have enough contrast (this.image_data.min_col="+e.min_col+" this.image_data.max_col="+e.max_col+")"}e.threshold=r/(t*n);e.getGray=function(e,t,n){var r=0;var i;for(i=e;i<e+n;i++){var s;for(s=t;s<t+n;s++){var o=i*4+s*this.width*4;r=r+.3*this.data[o]+.59*this.data[o+1]+.11*this.data[o+2]}}return r/n/n};e.isDark=function(e,t,n){var r=this.getGray(e,t,n);return r<this.threshold};this.image=e},decodeImage:function(e){this.image=e;return this.decode()},decode:function(){this.findImageBorders();this.max_version=40;this.decodeInsideBordersWithMaxVersion();return this.data},decodeInsideBordersWithMaxVersion:function(){this.findModuleSize();this.setFunctionalPattern();this.extractCodewords();this.setBlocks();this.correctErrors();this.extractData();return this.data},addTextImplementation:function(e,t){function n(e,t,n,r){var i=t>>>3;var s=24-(t&7)-n;var o=r<<s;e[i+2]=o&255;o=o>>>8;e[i+1]=o&255;o=o>>>8;e[i]+=o&255}function r(e,t){if(!e.alphanum_rev.hasOwnProperty(t)){throw"Invalid character for Alphanumeric encoding ["+t+"]"}return e.alphanum_rev[t]}function i(e,t){var i=t.length;var s=e.nCountBits(e.MODE.AlphaNumeric,e.version);n(e.data,e.bit_idx,s,i);e.bit_idx+=s;var o;for(o=0;o<i-1;o+=2){var u=45*r(e,t[o])+r(e,t[o+1]);n(e.data,e.bit_idx,11,u);e.bit_idx+=11}if(i%2){n(e.data,e.bit_idx,6,r(e,t[i-1]));e.bit_idx+=6}}function s(e,t){var r=e.nCountBits(e.MODE.EightBit,e.version);n(e.data,e.bit_idx,r,t.length);e.bit_idx+=r;var i;for(i=0;i<t.length;i++){n(e.data,e.bit_idx,8,t[i].charCodeAt());e.bit_idx+=8}}function o(e,t){var r=t.length;var i=e.nCountBits(e.MODE.Numeric,e.version);n(e.data,e.bit_idx,i,r);e.bit_idx+=i;var s=[];var o;var u;for(u=0;u<r;u++){var a=t[u].charCodeAt()-48;if(a<0||a>9){throw"Invalid character for Numeric encoding ["+t[u]+"]"}s.push(a)}for(u=0;u<r-2;u+=3){o=100*s[u]+10*s[u+1]+s[u+2];n(e.data,e.bit_idx,10,o);e.bit_idx+=10}if(r%3===1){o=s[r-1];n(e.data,e.bit_idx,4,o);e.bit_idx+=4}else if(r%3===2){o=10*s[r-2]+s[r-1];n(e.data,e.bit_idx,7,o);e.bit_idx+=7}}n(this.data,this.bit_idx,4,e);this.bit_idx+=4;if(e===this.MODE.AlphaNumeric){i(this,t)}else if(e===this.MODE.EightBit){s(this,t)}else if(e===this.MODE.Numeric){o(this,t)}else if(e===this.MODE.Terminator){return}else{throw"Unsupported ECI mode: "+e}if(this.debug_addText){if(this.logger){this.logger.debug("addTextImplementation data = "+this.data.join(","))}}if(this.debug_addText){if(this.logger){this.logger.debug("addTextImplementation bit_idx/8="+this.bit_idx/8+" n="+this.n_data_codewords)}}if(this.bit_idx/8>this.n_data_codewords){throw"Text too long for this EC version"}},appendPadding:function(){var e;for(e=Math.floor((this.bit_idx-1)/8)+1;e<this.n_data_codewords;e+=2){this.data[e]=236;this.data[e+1]=17}},addErrorCorrection:function(){if(this.debug_addText){if(this.logger){this.logger.debug("addErrorCorrection data = "+this.data.join(","))}}var e=new ReedSolomon(this.n_block_ec_words);if(this.debug_addErrorCorrection){e.logger=this.logger}var t=[];var n=0;var r;for(r=0;r<this.block_data_lengths.length;r++){var i=this.block_data_lengths[r];var s=this.data.slice(n,n+i);n+=i;var o;for(o=0;o<i;o++){t[this.block_indices[r][o]]=s[o]}var u=e.encode(s);for(o=0;o<u.length;o++){t[this.block_indices[r][i+o]]=u[o]}}if(this.debug_addErrorCorrection){if(this.logger){this.logger.debug("addErrorCorrection bytes = "+t.join(","))}}this.bytes=t},calculatePenalty:function(e){function t(e){var t=0;var n;for(n=0;n<e.n_modules;n++){var r=[0,0];var i=[0,0];var s;for(s=0;s<=1;s++){var o;for(o=0;o<e.n_modules;o++){if(e.pixels[s*n+(1-s)*o][(1-s)*n+s*o]){if(i[s]>5){t+=3+i[s]-5}i[s]=0;r[s]++}else{if(r[s]>5){t+=3+r[s]-5}i[s]++;r[s]=0}}if(i[s]>5){t+=3+i[s]-5}if(r[s]>5){t+=3+r[s]-5}}}return t}function n(e){var t=0;var n;for(n=0;n<e.n_modules-1;n++){var r;for(r=0;r<e.n_modules-1;r++){var i=0;if(e.pixels[n][r]){i++}if(e.pixels[n+1][r]){i++}if(e.pixels[n][r+1]){i++}if(e.pixels[n+1][r+1]){i++}if(i===0||i===4){t+=3}}}return t}function r(e){return("00000000000000"+e.toString(2)).slice(-15)}function i(e){var t=0;var n=128-1-2-32<<4;var i=2048-1;var s=i<<4;var o=32768-1;var u;for(u=0;u<e.n_modules-1;u++){var a=[0,0];var f;for(f=0;f<e.n_modules-1;f++){var l;for(l=0;l<=1;l++){a[l]=a[l]<<1&o;if(e.pixels[l*u+(1-l)*f][(1-l)*u+l*f]){a[l]++}if(e.debug_insane){e.logger.debug("PENALTY p="+t+" x="+(l*u+(1-l)*f)+" y="+((1-l)*u+l*f)+" pat="+r(a[l])+" b1="+r(a[l]&i)+" p2="+r(a[l]&s)+" bad="+r(n))}if(f>=7+4){if((a[l]&i)===n){t+=40}else{if(f<e.n_modules-4-7){if((a[l]&s)===n){t+=40}}}}}}}return t}function s(e){var t=0;var n;for(n=0;n<e.n_modules-1;n++){var r;for(r=0;r<e.n_modules-1;r++){if(e.pixels[n][r]){t++}}}return 10*Math.floor(Math.abs(t/(e.n_modules*e.n_modules)-.5)/.05)}var o=t(this);var u=n(this);var a=i(this);var f=s(this);var l=o+u+a+f;if(this.debug_encodeBestMask){if(this.logger){this.logger.debug("mask="+e+" penalty="+l+" ("+o+", "+u+", "+a+", "+f+")")}}return l},encodeBestMask:function(){var e=0;var t=999999;this.setFunctionalPattern();var n;var r;var i;for(n=0;n<8;n++){for(r=0;r<this.n_modules;r++){for(i=0;i<this.n_modules;i++){this.pixels[r][i]=false}}this.encodeFunctionalPatterns(n);this.encodeData(n);var s=this.calculatePenalty(n);if(s<t){t=s;e=n}}if(this.debug_encodeBestMask){if(this.logger){this.logger.debug("best_mask="+e+" best_penalty="+t)}}this.mask=e;if(this.mask!==7){for(r=0;r<this.n_modules;r++){for(i=0;i<this.n_modules;i++){this.pixels[r][i]=false}}this.encodeFunctionalPatterns(this.mask);this.encodeData(this.mask)}},encodeFunctionalPatterns:function(e){function t(e,t,n){var r,i;for(r=0;r<=5;r++){e.pixels[t+r][n]=true;e.pixels[t+6][n+r]=true;e.pixels[t+6-r][n+6]=true;e.pixels[t][n+6-r]=true}for(r=2;r<=4;r++){for(i=2;i<=4;i++){e.pixels[t+r][n+i]=true}}}function n(e){var t=e.version_info[e.version];var n;for(n=0;n<6;n++){var r;for(r=e.n_modules-11;r<e.n_modules-11+3;r++){if(t&1){e.pixels[r][n]=true}t/=2}}}function r(e){var t=e.version_info[e.version];var n;for(n=0;n<6;n++){var r;for(r=e.n_modules-11;r<e.n_modules-11+3;r++){if(t&1){e.pixels[n][r]=true}t/=2}}}function i(e,t){var n;for(n=8;n<e.n_modules-8;n+=2){if(t){e.pixels[n][6]=true}else{e.pixels[6][n]=true}}}function s(e,t,n){var r;for(r=0;r<=3;r++){e.pixels[t+r][n]=true;e.pixels[t+4][n+r]=true;e.pixels[t+4-r][n+4]=true;e.pixels[t][n+4-r]=true}e.pixels[t+2][n+2]=true}function o(e){var t=e.alignment_patterns[e.version].length;var n;for(n=0;n<t;n++){var r;for(r=0;r<t;r++){if(n===0&&r===0||n===0&&r===t-1||n===t-1&&r===0){continue}s(e,e.alignment_patterns[e.version][n]-2,e.alignment_patterns[e.version][r]-2)}}}function u(e,t){var n=8;var r;for(r=0;r<=5;r++){if(t&1){e.pixels[n][r]=true}t/=2}if(t&1){e.pixels[8][7]=true}t/=2;if(t&1){e.pixels[8][8]=true}t/=2;if(t&1){e.pixels[7][8]=true}t/=2;r=8;for(n=5;n>=0;n--){if(t&1){e.pixels[n][r]=true}t/=2}}function a(e,t){var n=8;var r;for(r=e.n_modules-1;r>e.n_modules-1-8;r--){if(t&1){e.pixels[r][n]=true}t/=2}r=8;for(n=e.n_modules-7;n<e.n_modules-1;n++){if(t&1){e.pixels[r][n]=true}t/=2}}t(this,0,0);t(this,0,this.n_modules-7);t(this,this.n_modules-7,0);if(this.version>=7){n(this);r(this)}i(this,true);i(this,false);if(this.version>1){o(this)}var f=this.format_info[e+8*this.error_correction_level];u(this,f);a(this,f)},encodeData:function(e){function t(e,t,n,r,i){var s;switch(t){case 0:s=(r+n)%2;break;case 1:s=r%2;break;case 2:s=n%3;break;case 3:s=(r+n)%3;break;case 4:s=(Math.floor(r/2)+Math.floor(n/3))%2;break;case 5:s=r*n%2+r*n%3;break;case 6:s=(r*n%2+r*n%3)%2;break;case 7:s=((r+n)%2+r*n%3)%2;break}if(s===0){e[n][r]=!i}else{e[n][r]=i}}var n=true;var r=0;var i=this.bytes[r];var s=0;var o=1<<7;var u;for(u=this.n_modules-1;u>0;u-=2){if(u===6){u--}var a;for(a=0;a<this.n_modules;a++){var f=n?this.n_modules-1-a:a;var l;for(l=0;l<2;l++){if(!this.functional_pattern[u-l][f]){t(this.pixels,e,u-l,f,i&o);o=o>>>1;s++;if(s===8){s=0;o=1<<7;r++;i=this.bytes[r]}}}}n^=true}},pixelsToImage:function(){var e,t;for(e=0;e<this.n_modules;e++){for(t=0;t<this.n_modules;t++){if(this.pixels[e][t]){this.setDark(e,t)}}}},findImageBorders:function(){var e,t,n;var r=7;var i=2;for(e=0;e<this.image.width;e++){n=0;for(t=0;t<this.image.height;t++){n=n+this.image.isDark(e,t,1)}if(n>=r){break}}this.image_left=e;for(e=this.image.width-1;e>=0;e--){n=0;for(t=0;t<this.image.height;t++){n=n+this.image.isDark(e,t,1)}if(n>=r){break}}this.image_right=e;for(t=0;t<this.image.height;t++){n=0;for(e=0;e<this.image.width;e++){n=n+this.image.isDark(e,t,1)}if(n>=r){break}}this.image_top=t;for(t=this.image.height-1;t>=0;t--){n=0;for(e=0;e<this.image.width;e++){n=n+this.image.isDark(e,t,1)}if(n>=r){break}}this.image_bottom=t;if(this.logger){this.logger.debug("left="+this.image_left+" right="+this.image_right+" top="+this.image_top+" bottom="+this.image_bottom)}if(this.image_right-this.image_left+1<21||this.image_bottom-this.image_top+1<21){throw"Found no image data to decode"}if(Math.abs(this.image_right-this.image_left-(this.image_bottom-this.image_top))>i){throw"Image data is not rectangular"}this.image_size=(this.image_right-this.image_left+1+(this.image_bottom-this.image_top+1))/2;if(this.logger){this.logger.debug("size="+this.image_size)}},findModuleSize:function(){function e(e,t,n,r,i,s){var o,u;var a=0;for(o=0;o<=5;o++){if(e.isDarkWithSize(t+o,n,s)){a=a+1}if(e.isDarkWithSize(t+6,n+o,s)){a=a+1}if(e.isDarkWithSize(t+6-o,n+6,s)){a=a+1}if(e.isDarkWithSize(t,n+6-o,s)){a=a+1}}for(o=0;o<=3;o++){if(!e.isDarkWithSize(t+o+1,n+1,s)){a=a+1}if(!e.isDarkWithSize(t+5,n+o+1,s)){a=a+1}if(!e.isDarkWithSize(t+5-o,n+5,s)){a=a+1}if(!e.isDarkWithSize(t+1,n+5-o,s)){a=a+1}}for(o=0;o<=2;o++){for(u=0;u<=2;u++){if(e.isDarkWithSize(3+t,3+n,s)){a=a+1}}}for(o=0;o<=6;o++){if(!e.isDarkWithSize(t+r,n+o,s)){a=a+1}if(!e.isDarkWithSize(t+o,n+i,s)){a=a+1}}if(!e.isDarkWithSize(t+r,n+i,s)){a=a+1}return a}function t(e,t,n,r){var i=0;var s=6;var o=8;var u=0;var a=1;if(t){s=8;o=6;u=1;a=0}var f=5;var l=[];var c;for(c=0;c<f;c++){l.push(1)}var h=true;var p;for(p=0;p<n-8-8;p++){var d=s+p*u;var v=o+p*a;if(h===e.isDarkWithSize(d,v,r)){i++;l.push(1)}else{l.push(0)}h=!h;var m=0;for(c=l.length-f;c<l.length-1;c++){if(l[c]){m=m+1}}if(m<3){return 0}}return i}function n(e,t,n,r){var i=0;var s;for(s=0;s<=3;s++){if(e.isDarkWithSize(t+s,n,r)){i=i+1}if(e.isDarkWithSize(t+4,n+s,r)){i=i+1}if(e.isDarkWithSize(t+4-s,n+4,r)){i=i+1}if(e.isDarkWithSize(t,n+4-s,r)){i=i+1}}for(s=0;s<=1;s++){if(!e.isDarkWithSize(t+s+1,n+1,r)){i=i+1}if(!e.isDarkWithSize(t+3,n+s+1,r)){i=i+1}if(!e.isDarkWithSize(t+3-s,n+3,r)){i=i+1}if(!e.isDarkWithSize(t+1,n+3-s,r)){i=i+1}}if(e.isDarkWithSize(t+2,n+2,r)){i=i+1}return i}function r(e,t,r){var i=0;var s=e.alignment_patterns[t].length;var o,u;for(o=0;o<s;o++){for(u=0;u<s;u++){if(o===0&&u===0||o===0&&u===s-1||o===s-1&&u===0){continue}var a=n(e,e.alignment_patterns[t][o]-2,e.alignment_patterns[t][u]-2,r);if(a>24){i++}}}return i}function i(e,t){var n;for(n=7;n<=40;n++){var r=e.hammingDistance(t,e.version_info[n]);if(r<=3){return[n,r]}}return[0,4]}function s(e,t,n){var r=1;var s=0;var o,u;for(u=0;u<6;u++){for(o=t-11;o<t-11+3;o++){if(e.isDarkWithSize(o,u,n)){s+=r}r*=2}}return i(e,s)}function o(e,t,n){var r=1;var s=0;var o,u;for(o=0;o<6;o++){for(u=t-11;u<t-11+3;u++){if(e.isDarkWithSize(o,u,n)){s+=r}r*=2}}return i(e,s)}function u(e,t){var n;for(n=0;n<32;n++){var r=e.hammingDistance(t,e.format_info[n]);if(r<=3){return[n,r]}}return[0,4]}function a(e,t,n){var r=1;var i=0;var s=8;var o;for(o=0;o<=5;o++){if(e.isDarkWithSize(s,o,n)){i+=r}r*=2}if(e.isDarkWithSize(8,7,n)){i+=r}r*=2;if(e.isDarkWithSize(8,8,n)){i+=r}r*=2;if(e.isDarkWithSize(7,8,n)){i+=r}r*=2;o=8;for(s=5;s>=0;s--){if(e.isDarkWithSize(s,o,n)){i+=r}r*=2}return u(e,i)}function f(e,t,n){var r=1;var i=0;var s;var o=8;for(s=t-1;s>t-1-8;s--){if(e.isDarkWithSize(s,o,n)){i+=r}r*=2}s=8;for(o=t-7;o<t-1;o++){if(e.isDarkWithSize(s,o,n)){i+=r}r*=2}return u(e,i)}function l(e){var t=4;var n;for(n=0;n<3;n++){t=t-(64-e[n])}if(t<0){t=0}return t}function c(e,t){var n=(e[0]+e[1])/(2*t);n=1-n;if(n>=.14){return 0}if(n>=.11){return 1}if(n>=.07){return 2}if(n>=1e-5){return 3}return 4}function h(e,t){var n=e/t;n=1-n;if(n>=.3){return 0}if(n>=.2){return 1}if(n>=.1){return 2}if(n>=1e-5){return 3}return 4}function p(n,i){var u;var p=[];var d=n.nModulesFromVersion(i);var v=n.image_size/d;var m=[0,0,0];m[0]=e(n,0,0,7,7,v);if(m[0]<64-3){return[i,0]}m[1]=e(n,0,d-7,7,-1,v);if(m[0]+m[1]<64+64-3){return[i,0]}m[2]=e(n,d-7,0,-1,7,v);if(n.debug_findModuleSize){if(n.logger){n.logger.debug("matchVersion version="+i+" finder0="+m[0]+" finder1="+m[1]+" finder2="+m[2])}}u=l(m);if(u<1){return[i,0]}else{p.push(u)}var g=[0,0];var y=[0,0];if(i>=7){g=s(n,d,v);y=o(n,d,v);if(n.debug_findModuleSize){if(n.logger){n.logger.debug("matchVersion version="+i+" version topright = "+g[0]+" "+g[1]+" version bottomleft = "+y[0]+" "+y[1])}}var b=i;if(g[1]<y[1]){if(g[1]<4){b=g[0]}}else{if(y[1]<4){b=y[0]}}if(Math.abs(b-i)>2){if(n.debug_findModuleSize){if(n.logger){n.logger.debug("matchVersion: format info "+b+" is very different from original version info "+i)}}}if(b!==i){if(n.debug_findModuleSize){if(n.logger){n.logger.debug("matchVersion: revising version to "+b+" from "+i)}}i=b}d=n.nModulesFromVersion(i);v=n.image_size/d;u=Math.round((4-g[1]+(4-y[1]))/2);if(u<1){return[i,0]}else{p.push(u)}}var w=[0,0];w[0]=t(n,true,d,v);w[1]=t(n,false,d,v);u=c(w,d-8-8);if(u<1){return[i,0]}else{p.push(u)}var E=-3;if(i>1){E=r(n,i,v)}if(n.debug_findModuleSize){if(n.logger){var S=1;if(i>1){S=E/(n.alignment_patterns[i].length*n.alignment_patterns[i].length-3)}n.logger.debug("matchVersion version="+i+" timing0="+w[0]/(d-8-8)+" timing1="+w[1]/(d-8-8)+" alignment="+S)}}u=h(E,n.alignment_patterns[i].length*n.alignment_patterns[i].length-3);if(u<1){return[i,0]}else{p.push(u)}var x=a(n,d,v);var T=f(n,d,v);var N=0;if(x[1]<T[1]){N=x[0]}else{N=T[0]}var C=Math.floor(N/8);var k=N%8;if(n.debug_findModuleSize){if(n.logger){n.logger.debug("matchVersion version="+i+" format_NW ="+x[0]+" "+x[1]+" format_NESW ="+T[0]+" "+T[1]+" format = "+N+" ecl = "+C+" mask = "+k)}}u=Math.round((4-x[1]+(4-T[1]))/2);if(u<1){return[i,0]}else{p.push(u)}var L=4;var A;for(A=0;A<p.length;A++){if(p[A]<L){L=p[A]}}if(n.debug_findModuleSize){if(n.logger){var O="";for(A=0;A<p.length;A++){O=O+p[A]}O=O+"->"+"<b>"+L+"</b>";n.logger.debug("matchVersion version="+"<b>"+i+"</b>"+" grades(F(V)TAF): "+O)}}return[i,L,C,k]}var d=[0,0];var v;for(v=1;v<=this.max_version;v++){var m=p(this,v);if(m[1]>d[1]){d=m}if(m[1]===4){break}}this.version=d[0];this.n_modules=this.nModulesFromVersion(this.version);this.module_size=this.image_size/this.n_modules;this.functional_grade=d[1];this.error_correction_level=d[2];this.mask=d[3];if(this.logger){this.logger.debug("findModuleSize<b>"+" version="+this.version+" grade="+this.functional_grade+" error_correction_level="+this.error_correction_level+" mask="+this.mask+"</b>")}if(this.functional_grade<1){throw"Unable to decode a function pattern"}},extractCodewords:function(){function e(e,t,n){var r;switch(e.mask){case 0:r=(n+t)%2;break;case 1:r=n%2;break;case 2:r=t%3;break;case 3:r=(n+t)%3;break;case 4:r=(Math.floor(n/2)+Math.floor(t/3))%2;break;case 5:r=n*t%2+n*t%3;break;case 6:r=(n*t%2+n*t%3)%2;break;case 7:r=((n+t)%2+n*t%3)%2;break}var i;if(r===0){i=!e.isDark(t,n)}else{i=e.isDark(t,n)}if(e.debug_insane){if(e.logger){e.logger.debug("getUnmasked i="+n+" j="+t+" m="+r+" u="+i)}}return i}this.codewords=[];var t=true;var n=0;var r=128;var i=0;var s,o,u,a;for(o=this.n_modules-1;o>0;o-=2){if(o===6){o--}for(a=0;a<this.n_modules;a++){s=t?this.n_modules-1-a:a;for(u=0;u<2;u++){if(!this.functional_pattern[o-u][s]){if(e(this,o-u,s)){n+=r}r/=2;if(r<1){this.codewords.push(n);i=0;r=128;n=0}}}}t^=true}if(this.debug_extractCodewords){if(this.logger){this.logger.debug("getCodewords mask="+this.mask+" length="+this.codewords.length);this.logger.debug("getCodewords = "+this.codewords.join(","))}}},extractData:function(){function t(e,t,n,r){var i=24-(n&7)-r;var s=(1<<r)-1;var o=n>>>3;return(t[o]<<16|t[++o]<<8|t[++o])>>i&s}function n(e,n){var r=e.nCountBits(e.MODE.EightBit,e.version);var i=t(e,n,e.bit_idx,r);e.bit_idx+=r;if(e.debug_extractData){if(e.logger){e.logger.debug("extract charcount = "+i)}}var s="";var o;for(o=0;o<i;o++){s+=String.fromCharCode(t(e,n,e.bit_idx,8));e.bit_idx+=8}return s}function r(e,n){var r=e.nCountBits(e.MODE.AlphaNumeric,e.version);var i=t(e,n,e.bit_idx,r);e.bit_idx+=r;if(e.debug_extractData){if(e.logger){e.logger.debug("extractAlphanum charcount = "+i)}}var s="";var o;for(o=0;o<Math.floor(i/2);o++){var u=t(e,n,e.bit_idx,11);s+=e.alphanum[Math.floor(u/45)];s+=e.alphanum[u%45];e.bit_idx+=11}if(i%2){s+=e.alphanum[t(e,n,e.bit_idx,6)];e.bit_idx+=6}return s}function i(e,n){var r=e.nCountBits(e.MODE.Numeric,e.version);var i=t(e,n,e.bit_idx,r);e.bit_idx+=r;if(e.debug_extractData){if(e.logger){e.logger.debug("extractNumeric charcount = "+i)}}var s="";var o,u,a,f;var l;for(l=0;l<Math.floor(i/3);l++){o=t(e,n,e.bit_idx,10);e.bit_idx+=10;u=Math.floor(o/100);a=Math.floor(o%100/10);f=o%10;s+=String.fromCharCode(48+u,48+a,48+f)}if(i%3===1){o=t(e,n,e.bit_idx,4);e.bit_idx+=4;s+=String.fromCharCode(48+o)}else if(i%3===2){o=t(e,n,e.bit_idx,7);e.bit_idx+=7;u=Math.floor(o/10);a=o%10;s+=String.fromCharCode(48+u,48+a)}return s}var e;var s=this.bytes;e=s.length*8;if(this.debug_extractData){if(this.logger){this.logger.debug("extractData bytes in ("+s.length+") = "+s.join(","))}}var o;for(o=0;o<4;o++){s.push(0)}this.data="";this.bit_idx=0;while(this.bit_idx<e-4){var u=t(this,s,this.bit_idx,4);this.bit_idx+=4;if(this.debug_extractData){if(this.logger){this.logger.debug("extractData mode = "+u)}}if(u===this.MODE.Terminator){break}else if(u===this.MODE.AlphaNumeric){this.data+=r(this,s)}else if(u===this.MODE.EightBit){this.data+=n(this,s)}else if(u===this.MODE.Numeric){this.data+=i(this,s)}else{throw"Unsupported ECI mode: "+u}}if(this.debug_extractData){if(this.logger){var a=[];for(o=0;o<this.data.length;o++){a.push(this.data[o].charCodeAt())}this.logger.debug("extractData data("+a.length+") = "+a.join(","))}}},correctErrors:function(){var e=new ReedSolomon(this.n_block_ec_words);if(this.debug_correctErrors){e.logger=this.logger}var t=[];var n=[];var r=4;var i;for(i=0;i<this.block_indices.length;i++){var s=[];var o;for(o=0;o<this.block_indices[i].length;o++){s.push(this.codewords[this.block_indices[i][o]])}var u=e.decode(s);if(this.debug_correctErrors){if(this.logger){this.logger.debug("correctErrors in  = "+s.join(","));this.logger.debug("correctErrors out = "+u.join(","))}}if(!e.corrected){this.error_grade=0;throw"Unable to correct errors ("+e.uncorrected_reason+")"}n=n.concat(u);t.push(e.n_errors)}this.errors=t;this.bytes=n;this.error_grade=this.gradeErrors(t);if(this.logger){this.logger.debug("error_grade="+r)}},gradeErrors:function(e){var t=this.n_block_ec_words;var n=0;var r;for(r=0;r<e.length;r++){if(e[r]>n){n=e[r]}}var i=4;if(n>t/2-1){i=0}else if(n>t/2-2){i=1}else if(n>t/2-3){i=2}else if(n>t/2-4){i=3}return i},getDataCapacity:function(e,t,n){var r=this.n_codewords[e];var i=this.n_ec_codewords[e][t];var s=r-i;var o=8*s;o-=4;o-=this.nCountBits(n,e);var u=0;if(n===this.MODE.AlphaNumeric){u=Math.floor(o/11)*2;if(o>=u/2*11+6){u++}}else if(n===this.MODE.EightBit){u=Math.floor(o/8)}else if(n===this.MODE.Numeric){u=Math.floor(o/10)*3;if(o>=u/3*10+4){if(o>=u/3*10+7){u++}u++}}else{throw"Unsupported ECI mode: "+n}return u},getVersionFromLength:function(e,t,n){var r;for(r=1;r<=40;r++){if(this.getDataCapacity(r,e,t)>=n){return r}}throw"Text is too long, even for a version 40 QR Code"},setBlocks:function(){var e=this.n_codewords[this.version];var t=this.n_ec_codewords[this.version][this.error_correction_level];this.n_data_codewords=e-t;var n=this.ec_blocks[this.version][this.error_correction_level];var r;var i;var s;var o;var u;var a,f;if(n.length===1){i=n[0];s=0;r=i;o=this.n_data_codewords/r;u=0}else{i=n[0];s=n[1];r=i+s;o=Math.floor(this.n_data_codewords/r);u=o+1}this.n_block_ec_words=t/r;if(this.debug_setBlocks){if(this.logger){this.logger.debug("setBlocks"+" n_blocks_first="+i+" n_blocks_second="+s+" n_blocks="+r+" n_block_words_first="+o+" n_block_words_second="+u+" n_block_ec_words="+this.n_block_ec_words+" total="+(i*o+s*u+r*this.n_block_ec_words))}}this.block_data_lengths=[];for(f=0;f<i;f++){this.block_data_lengths[f]=o}for(f=i;f<r;f++){this.block_data_lengths[f]=u}this.block_indices=[];for(f=0;f<r;f++){this.block_indices[f]=[]}var l=0;for(a=0;a<o;a++){for(f=0;f<r;f++){this.block_indices[f].push(l);l++}}for(f=i;f<r;f++){this.block_indices[f].push(l);l++}for(a=0;a<this.n_block_ec_words;a++){for(f=0;f<r;f++){this.block_indices[f].push(l);l++}}if(this.debug_setBlocks){if(this.logger){for(f=0;f<r;f++){this.logger.debug("setBlocks block "+f+" ("+this.block_indices[f].length+"): "+this.block_indices[f].join(","))}}}},setFunctionalPattern:function(){function e(e,t,n,r,i){var s,o;for(s=t;s<t+r;s++){for(o=n;o<n+i;o++){e.functional_pattern[s][o]=true}}}function t(t){var n=t.alignment_patterns[t.version].length;var r,i;for(r=0;r<n;r++){for(i=0;i<n;i++){if(r===0&&i===0||r===0&&i===n-1||r===n-1&&i===0){continue}e(t,t.alignment_patterns[t.version][r]-2,t.alignment_patterns[t.version][i]-2,5,5)}}}this.functional_pattern=[];var n,r;for(n=0;n<this.n_modules;n++){this.functional_pattern[n]=[];for(r=0;r<this.n_modules;r++){this.functional_pattern[n][r]=false}}e(this,0,0,9,9);e(this,this.n_modules-8,0,8,9);e(this,0,this.n_modules-8,9,8);e(this,8,6,this.n_modules-8-8,1);e(this,6,8,1,this.n_modules-8-8);t(this);if(this.version>=7){e(this,0,this.n_modules-11,6,3);e(this,this.n_modules-11,0,3,6)}if(this.debug_insane){if(this.logger){for(r=0;r<this.n_modules;r++){var i="";for(n=0;n<this.n_modules;n++){i+=this.functional_pattern[n][r]?"X":"O"}this.logger.debug(i)}}}},nCountBits:function(e,t){if(e===this.MODE.EightBit){if(t<10){return 8}else{return 16}}else if(e===this.MODE.AlphaNumeric){if(t<10){return 9}else if(t<27){return 11}else{return 13}}else if(e===this.MODE.Numeric){if(t<10){return 10}else if(t<27){return 12}else{return 14}}throw"Internal error: Unknown mode: "+e},nModulesFromVersion:function(e){return 17+4*e},hammingDistance:function(e,t){function n(e){var t;for(t=0;e;t++){e&=e-1}return t}var r=e^t;return n(r)},isDarkWithSize:function(e,t,n){return this.image.isDark(Math.round(this.image_left+e*n),Math.round(this.image_top+t*n),Math.round(n))},isDark:function(e,t){return this.isDarkWithSize(e,t,this.module_size)},setDark:function(e,t){this.image.setDark(this.image_left+e*this.module_size,this.image_top+t*this.module_size,this.module_size)},alignment_patterns:[null,[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],version_info:[null,null,null,null,null,null,null,31892,34236,39577,42195,48118,51042,55367,58893,63784,68472,70749,76311,79154,84390,87683,92361,96236,102084,102881,110507,110734,117786,119615,126325,127568,133589,136944,141498,145311,150283,152622,158308,161089,167017],format_info:[21522,20773,24188,23371,17913,16590,20375,19104,30660,29427,32170,30877,26159,25368,27713,26998,5769,5054,7399,6608,1890,597,3340,2107,13663,12392,16177,14854,9396,8579,11994,11245],n_codewords:[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706],n_ec_codewords:[null,[10,7,17,13],[16,10,28,22],[26,15,44,36],[36,20,64,52],[48,26,88,72],[64,36,112,96],[72,40,130,108],[88,48,156,132],[110,60,192,160],[130,72,224,192],[150,80,264,224],[176,96,308,260],[198,104,352,288],[216,120,384,320],[240,132,432,360],[280,144,480,408],[308,168,532,448],[338,180,588,504],[364,196,650,546],[416,224,700,600],[442,224,750,644],[476,252,816,690],[504,270,900,750],[560,300,960,810],[588,312,1050,870],[644,336,1110,952],[700,360,1200,1020],[728,390,1260,1050],[784,420,1350,1140],[812,450,1440,1200],[868,480,1530,1290],[924,510,1620,1350],[980,540,1710,1440],[1036,570,1800,1530],[1064,570,1890,1590],[1120,600,1980,1680],[1204,630,2100,1770],[1260,660,2220,1860],[1316,720,2310,1950],[1372,750,2430,2040]],ec_blocks:[[],[[1],[1],[1],[1]],[[1],[1],[1],[1]],[[1],[1],[2],[2]],[[2],[1],[4],[2]],[[2],[1],[2,2],[2,2]],[[4],[2],[4],[4]],[[4],[2],[4,1],[2,4]],[[2,2],[2],[4,2],[4,2]],[[3,2],[2],[4,4],[4,4]],[[4,1],[2,2],[6,2],[6,2]],[[1,4],[4],[3,8],[4,4]],[[6,2],[2,2],[7,4],[4,6]],[[8,1],[4],[12,4],[8,4]],[[4,5],[3,1],[11,5],[11,5]],[[5,5],[5,1],[11,7],[5,7]],[[7,3],[5,1],[3,13],[15,2]],[[10,1],[1,5],[2,17],[1,15]],[[9,4],[5,1],[2,19],[17,1]],[[3,11],[3,4],[9,16],[17,4]],[[3,13],[3,5],[15,10],[15,5]],[[17],[4,4],[19,6],[17,6]],[[17],[2,7],[34],[7,16]],[[4,14],[4,5],[16,14],[11,14]],[[6,14],[6,4],[30,2],[11,16]],[[8,13],[8,4],[22,13],[7,22]],[[19,4],[10,2],[33,4],[28,6]],[[22,3],[8,4],[12,28],[8,26]],[[3,23],[3,10],[11,31],[4,31]],[[21,7],[7,7],[19,26],[1,37]],[[19,10],[5,10],[23,25],[15,25]],[[2,29],[13,3],[23,28],[42,1]],[[10,23],[17],[19,35],[10,35]],[[14,21],[17,1],[11,46],[29,19]],[[14,23],[13,6],[59,1],[44,7]],[[12,26],[12,7],[22,41],[39,14]],[[6,34],[6,14],[2,64],[46,10]],[[29,14],[17,4],[24,46],[49,10]],[[13,32],[4,18],[42,32],[48,14]],[[40,7],[20,4],[10,67],[43,22]],[[18,31],[19,6],[20,61],[34,34]]],n_remainder_bits:[null,0,7,7,7,7,7,0,0,0,0,0,0,0,3,3,3,3,3,3,3,4,4,4,4,4,4,4,3,3,3,3,3,3,3,0,0,0,0,0,0],alphanum:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"],alphanum_rev:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:18,J:19,K:20,L:21,M:22,N:23,O:24,P:25,Q:26,R:27,S:28,T:29,U:30,V:31,W:32,X:33,Y:34,Z:35," ":36,$:37,"%":38,"*":39,"+":40,"-":41,".":42,"/":43,":":44}};"use strict";ReedSolomon.prototype={encode:function(e){if(this.gen_poly==null){this.gen_poly=this.genPoly(this.n_ec_bytes)}var t=new Array(this.n_ec_bytes+1);var n;for(n=0;n<this.n_ec_bytes+1;n++){t[n]=0}for(n=0;n<e.length;n++){var r=e[n]^t[this.n_ec_bytes-1];var i;for(i=this.n_ec_bytes-1;i>0;i--){t[i]=t[i-1]^this.gmult(this.gen_poly[i],r)}t[0]=this.gmult(this.gen_poly[0],r)}var s=[];for(n=this.n_ec_bytes-1;n>=0;n--){s.push(t[n])}return s},decode:function(e){this.bytes_in=e;this.bytes_out=e.slice();var t=this.calculateSyndroms();if(t>0){this.correctErrors()}else{this.corrected=true}return this.bytes_out.slice(0,this.bytes_out.length-this.n_ec_bytes)},genPoly:function(e){var t;var n;var r;n=this.zeroPoly();n[0]=1;var i;for(i=0;i<e;i++){t=this.zeroPoly();t[0]=this.gexp[i];t[1]=1;r=this.multPolys(t,n);n=this.copyPoly(r)}if(this.logger){this.logger.debug("RS genPoly: "+r.join(","))}return r},calculateSyndroms:function(){this.syndroms=[];var e;var t=0;var n,r;for(r=0;r<this.n_ec_bytes;r++){e=0;for(n=0;n<this.bytes_in.length;n++){e=this.bytes_in[n]^this.gmult(this.gexp[r],e)}this.syndroms.push(e);if(e>0){t++}}if(this.logger){if(t>0){this.logger.debug("RS calculateSyndroms: <b>Errors found!</b> syndroms = "+this.syndroms.join(","))}else{this.logger.debug("RS calculateSyndroms: <b>No errors</b>")}}return t},correctErrors:function(){this.berlekampMassey();this.findRoots();this.corrected=false;if(2*this.n_errors>this.n_ec_bytes){this.uncorrected_reason="too many errors";if(this.logger){this.logger.debug("RS correctErrors: <b>"+this.uncorrected_reason+"</b>")}return}var e;for(e=0;e<this.n_errors;e++){if(this.error_locs[e]>=this.bytes_in.length){this.uncorrected_reason="corrections out of scope";if(this.logger){this.logger.debug("RS correctErrors: <b>"+this.uncorrected_reason+"</b>")}return}}if(this.n_errors===0){this.uncorrected_reason="could not identify errors";if(this.logger){this.logger.debug("RS correctErrors: <b>"+this.uncorrected_reason+"</b>")}return}var t;for(t=0;t<this.n_errors;t++){var n=this.error_locs[t];var r=0;var i;for(i=0;i<this.n_degree_max;i++){r^=this.gmult(this.omega[i],this.gexp[(255-n)*i%255])}var s=0;for(i=0;i<this.n_degree_max;i+=2){s^=this.gmult(this.psi[i],this.gexp[(255-n)*i%255])}var o=this.gmult(r,this.ginv(s));if(this.logger){this.logger.debug("RS correctErrors: loc="+(this.bytes_out.length-n-1)+"  err = 0x0"+o.toString(16)+" = bin "+o.toString(2))}this.bytes_out[this.bytes_out.length-n-1]^=o}this.corrected=true},berlekampMassey:function(){var e=this.zeroPoly();e[0]=1;var t=this.copyPoly(e);this.mulZPoly(t);this.psi=this.copyPoly(e);var n=new Array(this.n_degree_max);var r=-1;var i=0;var s;var o;for(o=0;o<this.n_ec_bytes;o++){var u=this.computeDiscrepancy(this.psi,this.syndroms,i,o);if(u!==0){for(s=0;s<this.n_degree_max;s++){n[s]=this.psi[s]^this.gmult(u,t[s])}if(i<o-r){var a=o-r;r=o-i;for(s=0;s<this.n_degree_max;s++){t[s]=this.gmult(this.psi[s],this.ginv(u))}i=a}this.psi=this.copyPoly(n)}this.mulZPoly(t)}if(this.logger){this.logger.debug("RS berlekampMassey: psi = "+this.psi.join(","))}var f=this.multPolys(this.psi,this.syndroms);this.omega=this.zeroPoly();for(s=0;s<this.n_ec_bytes;s++){this.omega[s]=f[s]}if(this.logger){this.logger.debug("RS berlekampMassey: omega = "+this.omega.join(","))}},findRoots:function(){this.n_errors=0;this.error_locs=[];var e;var t;for(t=1;t<256;t++){e=0;var n;for(n=0;n<this.n_ec_bytes+1;n++){e^=this.gmult(this.gexp[n*t%255],this.psi[n])}if(e===0){this.error_locs.push(255-t);this.n_errors++}}if(this.logger){this.logger.debug("RS findRoots: errors=<b>"+this.n_errors+"</b> locations = "+this.error_locs.join(","))}},computeDiscrepancy:function(e,t,n,r){var i=0;var s;for(s=0;s<=n;s++){i^=this.gmult(e[s],t[r-s])}return i},copyPoly:function(e){var t=new Array(this.n_degree_max);var n;for(n=0;n<this.n_degree_max;n++){t[n]=e[n]}return t},zeroPoly:function(){var e=new Array(this.n_degree_max);var t;for(t=0;t<this.n_degree_max;t++){e[t]=0}return e},mulZPoly:function(e){var t;for(t=this.n_degree_max-1;t>0;t--){e[t]=e[t-1]}e[0]=0},multPolys:function(e,t){var n=new Array(this.n_degree_max);var r=new Array(this.n_degree_max*2);var i;for(i=0;i<this.n_degree_max*2;i++){n[i]=0}for(i=0;i<this.n_degree_max;i++){var s;for(s=this.n_degree_max;s<this.n_degree_max*2;s++){r[s]=0}for(s=0;s<this.n_degree_max;s++){r[s]=this.gmult(t[s],e[i])}for(s=this.n_degree_max*2-1;s>=i;s--){r[s]=r[s-i]}for(s=0;s<i;s++){r[s]=0}for(s=0;s<this.n_degree_max*2;s++){n[s]^=r[s]}}return n},initGaloisTables:function(){var e=0;var t=1;var n=0;var r=0;var i=0;var s=0;var o=0;var u=0;var a=0;this.gexp=new Array(512);this.glog=new Array(256);this.gexp[0]=1;this.gexp[255]=this.gexp[0];this.glog[0]=0;var f;for(f=1;f<256;f++){e=a;a=u;u=o;o=s;s=i^e;i=r^e;r=n^e;n=t;t=e;this.gexp[f]=t+n*2+r*4+i*8+s*16+o*32+u*64+a*128;this.gexp[f+255]=this.gexp[f]}for(f=1;f<256;f++){var l;for(l=0;l<256;l++){if(this.gexp[l]===f){this.glog[f]=l;break}}}},gmult:function(e,t){if(e===0||t===0){return 0}var n=this.glog[e];var r=this.glog[t];return this.gexp[n+r]},ginv:function(e){return this.gexp[255-this.glog[e]]}}
